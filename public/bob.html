<!DOCTYPE html>
<html>

<head>
    <title>DIDComm Query (Bob)</title>
    <link rel="stylesheet" type="text/css" href="/css/styles.css">
</head>

<body>
    <h1>DIDComm Query (Bob)</h1>

    <!-- Input element for message content -->
    <input type="text" id="messageContent" placeholder="Enter your message" value="SELECT * FROM DUAL;">

    <!-- Button to trigger API actions -->
    <button id="callApiButton">Send query</button>

    <!-- Element to display API responses -->
    <div id="apiResponse">
        <h2>Receipt confirmation:</h2>
    </div>

    <div id="logContainer">
        <h2>Received:</h2>
    </div>

    <script>
        const callApiButton = document.getElementById("callApiButton");

        // Function to generate a timestamp in the format HH:mm:ss
        function getTimestamp() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        callApiButton.addEventListener("click", async () => {
            try {
                const apiResponse = document.getElementById("apiResponse");
                const messageContentInput = document.getElementById("messageContent");
                const messageContent = messageContentInput.value;

                const createInvitationResponse = await fetch(`http://localhost:3201/create-invitation`);
                const invitationData = await createInvitationResponse.json();

                await new Promise(resolve => setTimeout(resolve, 1000));

                const receiveInvitationResponse = await fetch(`http://localhost:3201/receive-invitation`);
                const receiveInvitationData = await receiveInvitationResponse.json();

                await new Promise(resolve => setTimeout(resolve, 1000));

                const sendMessageResponse = await fetch(`http://localhost:3201/send-message?messageContent=${messageContent}`);
                await new Promise(resolve => setTimeout(resolve, 1000));

                if (sendMessageResponse.ok) {
                    const fileContentsResponse = await fetch("http://localhost:3201/get-latest-message");
                    const fileText = await fileContentsResponse.text();

                    if (fileText.includes("issuer.agent received your message")) {
                        const timestampedMessage = `[${getTimestamp()}] Alice received your message`;
                        apiResponse.innerHTML = `<h2>Receipt confirmation:</h2><p>${timestampedMessage}</p>`;
                    } else {
                        const timestampedMessage = `[${getTimestamp()}] ${fileText}`;
                        apiResponse.innerHTML = `<h2>Receipt confirmation:</h2><p>${timestampedMessage}</p>`;
                    }
                } else {
                    const errorText = await sendMessageResponse.text();
                    const timestampedError = `[${getTimestamp()}] ${errorText}`;
                    apiResponse.innerHTML = `<h2>Error:</h2><p>${timestampedError}</p>`;
                }

                apiResponse.style.display = "block";
            } catch (error) {
                const timestampedError = `[${getTimestamp()}] ${error.message}`;
                apiResponse.innerHTML = `<h2>Error:</h2><p>${timestampedError}</p>`;
            }
        });

        try {
            const logContainer = document.getElementById("logContainer");

            function appendLogContent(logText) {
                const logMessage = document.createElement("p");

                if (logText.includes("issuer.agent received your message")) {
                    const timestampedMessage = `[${getTimestamp()}] Alice received your message`;
                    logMessage.textContent = timestampedMessage;
                } else {
                    const timestampedMessage = `[${getTimestamp()}] ${logText}`;
                    logMessage.textContent = timestampedMessage;
                }

                logContainer.appendChild(logMessage);
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            const logSSE = new EventSource("http://localhost:1081/log-sse");
            console.log("Connected to log SSE");

            logSSE.addEventListener("message", (event) => {
                const logText = event.data;
                appendLogContent(logText);
            });

            logContainer.style.display = "block";
        } catch (error) {
            const timestampedError = `[${getTimestamp()}] ${error.message}`;
            console.error("SSE Error:", error);
            logContainer.innerHTML = `<h2>Error:</h2><p>${timestampedError}</p>`;
        }
    </script>
</body>

</html>
