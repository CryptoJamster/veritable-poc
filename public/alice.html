<!DOCTYPE html>
<html>

<head>
    <title>DIDComm Query (Alice)</title>
    <link rel="stylesheet" type="text/css" href="/css/styles.css">
</head>

<body>
    <h1>DIDComm Query (Alice)</h1>

    <!-- Input element for message content -->
    <input type="text" id="messageContent" placeholder="Enter your message" value="SELECT * FROM DUAL;">

    <!-- Button to trigger API actions -->
    <button id="callApiButton">Send query</button>

    <!-- Element to display API responses -->
    <div id="logContainer" class="log-container">
        <h2>Latest message:</h2>
        <p id="latestMessage"></p>
    </div>

    <script>
        const callApiButton = document.getElementById("callApiButton");

        function getTimestamp() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        async function fetchLatestMessage() {
    try {
        const fileContentsResponse = await fetch("http://localhost:3200/get-latest-message");
        const fileText = await fileContentsResponse.text();

        if (fileText.trim() !== '') {
            if (fileText.includes("verifier.agent received your message")) {
                return `Bob received your message`;
            } else {
                return `${fileText}`;
            }
        } else {
            return null;
        }
    } catch (error) {
        console.error("Error fetching latest message:", error);
        return null; // Return null in case of an error
    }
}


        async function logLatestMessage(message) {
            const latestMessageElement = document.getElementById("latestMessage");
            latestMessageElement.textContent = message;
        }

        async function updateLatestMessagePeriodically() {
            while (true) {
                const latestMessage = await fetchLatestMessage();
                if (latestMessage !== null) {
                    await logLatestMessage(`${latestMessage}`);
                }

                // Wait for 5 seconds before fetching the next message
                await new Promise(resolve => setTimeout(resolve, 5000));
            }
        }

        callApiButton.addEventListener("click", async () => {
            try {
                const messageContentInput = document.getElementById("messageContent");
                const messageContent = messageContentInput.value;

                const createInvitationResponse = await fetch(`http://localhost:3200/create-invitation`);
                const invitationData = await createInvitationResponse.json();

                await new Promise(resolve => setTimeout(resolve, 1000));

                const receiveInvitationResponse = await fetch(`http://localhost:3200/receive-invitation`);
                const receiveInvitationData = await receiveInvitationResponse.json();

                await new Promise(resolve => setTimeout(resolve, 1000));

                const sendMessageResponse = await fetch(`http://localhost:3200/send-message?messageContent=${messageContent}`);
                await new Promise(resolve => setTimeout(resolve, 1000));

                if (sendMessageResponse.ok) {
                    const latestMessage = await fetchLatestMessage();
                    await logLatestMessage(`${latestMessage}`);
                } else {
                    const errorText = await sendMessageResponse.text();
                    const timestampedError = `Error: ${errorText}`;
                    await logLatestMessage(timestampedError);
                }

            } catch (error) {
                const timestampedError = `Error: ${error.message}`;
                await logLatestMessage(timestampedError);
            }
        });

        // Start the periodic check when the page loads
        updateLatestMessagePeriodically();
    </script>
</body>

</html>
